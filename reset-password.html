<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パスワード再設定 - INTERCONNECT</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/auth-unified.css">
    <link rel="stylesheet" href="css/auth-message.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>INTERCONNECT</h1>
                <p>経営者コミュニティ</p>
            </div>

            <h2 class="auth-title">新しいパスワードを設定</h2>

            <div class="auth-description">
                <p>新しいパスワードを入力してください。</p>
            </div>

            <form class="auth-form" id="resetPasswordForm">
                <div class="form-group">
                    <label for="password">新しいパスワード</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" name="password" required minlength="8" placeholder="8文字以上で入力" autocomplete="new-password">
                        <button type="button" class="password-toggle" aria-label="パスワードを表示">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                        <small class="strength-text" id="strengthText"></small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password-confirm">新しいパスワード（確認）</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password-confirm" name="password-confirm" required minlength="8" placeholder="パスワードを再入力" autocomplete="new-password">
                        <button type="button" class="password-toggle" aria-label="パスワードを表示">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="auth-message" id="statusMessage" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="messageText"></span>
                </div>

                <button type="submit" class="auth-button" id="submitButton">
                    <span id="buttonText">パスワードを変更</span>
                    <i class="fas fa-spinner fa-spin" id="loadingIcon" style="display: none;"></i>
                </button>
            </form>

            <div class="auth-footer">
                <a href="login.html">ログインページに戻る</a>
            </div>

            <div class="auth-back">
                <a href="index.html">&larr; トップページに戻る</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/core-utils.js"></script>
    <script src="js/supabase-unified.js?v=1.1"></script>
    <script src="js/auth-background-safe.js"></script>
    <script>
    (function() {
        'use strict';

        // リカバリーセッションが確立されたかどうか
        var recoverySessionReady = false;

        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById('resetPasswordForm');
            var passwordInput = document.getElementById('password');
            var confirmInput = document.getElementById('password-confirm');
            var submitButton = document.getElementById('submitButton');
            var buttonText = document.getElementById('buttonText');
            var loadingIcon = document.getElementById('loadingIcon');
            var statusMessage = document.getElementById('statusMessage');
            var messageText = document.getElementById('messageText');
            var strengthFill = document.getElementById('strengthFill');
            var strengthText = document.getElementById('strengthText');

            // 初期状態: フォームを無効化（リカバリートークン検証待ち）
            submitButton.disabled = true;
            passwordInput.disabled = true;
            confirmInput.disabled = true;
            showMessage('リカバリートークンを検証中...', 'info');

            // Supabase初期化を待ってリカバリートークンを処理
            initRecoveryFlow();

            async function initRecoveryFlow() {
                // Supabase初期化を待つ
                if (window.waitForSupabase) {
                    await window.waitForSupabase();
                }

                if (!window.supabaseClient) {
                    showMessage('認証システムが初期化できませんでした。ページを再読み込みしてください。', 'error');
                    return;
                }

                // Supabase v2: onAuthStateChangeでPASSWORD_RECOVERYイベントを監視
                // メールリンクのトークンはSupabase SDKが自動的にURLフラグメントから取得・交換する
                var authTimeout = setTimeout(function() {
                    if (!recoverySessionReady) {
                        showMessage('リカバリーリンクが無効または期限切れです。<a href="forgot-password.html">パスワード再設定をやり直す</a>', 'error');
                    }
                }, 5000);

                var sub = window.supabaseClient.auth.onAuthStateChange(function(event, session) {
                    if (event === 'PASSWORD_RECOVERY') {
                        clearTimeout(authTimeout);
                        recoverySessionReady = true;
                        // フォームを有効化
                        submitButton.disabled = false;
                        passwordInput.disabled = false;
                        confirmInput.disabled = false;
                        statusMessage.style.display = 'none';
                        passwordInput.focus();
                    }
                });

                // 既にセッションがある場合のフォールバック（ページリロード時など）
                try {
                    var userData = await window.supabaseClient.auth.getUser();
                    if (userData.data && userData.data.user) {
                        clearTimeout(authTimeout);
                        recoverySessionReady = true;
                        submitButton.disabled = false;
                        passwordInput.disabled = false;
                        confirmInput.disabled = false;
                        statusMessage.style.display = 'none';
                        passwordInput.focus();
                    }
                } catch (e) {
                    // セッションなし - リカバリートークン待ち
                }
            }

            // パスワードトグル
            document.querySelectorAll('.password-toggle').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    var wrapper = this.closest('.password-input-wrapper');
                    var input = wrapper.querySelector('input');
                    var icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                        this.setAttribute('aria-label', 'パスワードを非表示');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                        this.setAttribute('aria-label', 'パスワードを表示');
                    }
                });
            });

            // パスワード強度インジケーター
            passwordInput.addEventListener('input', function() {
                var pw = this.value;
                var score = 0;
                if (pw.length >= 8) score++;
                if (pw.length >= 12) score++;
                if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) score++;
                if (/\d/.test(pw)) score++;
                if (/[^a-zA-Z0-9]/.test(pw)) score++;

                var percent = Math.min(score * 20, 100);
                var color = score <= 1 ? '#ef4444' : score <= 2 ? '#f59e0b' : score <= 3 ? '#eab308' : '#10b981';
                var label = score <= 1 ? '弱い' : score <= 2 ? 'やや弱い' : score <= 3 ? '普通' : '強い';

                strengthFill.style.width = percent + '%';
                strengthFill.style.background = color;
                strengthText.textContent = pw.length > 0 ? label : '';
                strengthText.style.color = color;
            });

            // フォーム送信
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!recoverySessionReady) {
                    showMessage('リカバリーセッションが確立されていません。メールのリンクから再度アクセスしてください。', 'error');
                    return;
                }

                var password = passwordInput.value;
                var confirm = confirmInput.value;

                if (password.length < 8) {
                    showMessage('パスワードは8文字以上で入力してください。', 'error');
                    return;
                }

                if (password !== confirm) {
                    showMessage('パスワードが一致しません。', 'error');
                    return;
                }

                submitButton.disabled = true;
                buttonText.style.display = 'none';
                loadingIcon.style.display = 'inline-block';

                try {
                    var result = await window.supabaseClient.auth.updateUser({
                        password: password
                    });

                    if (result.error) {
                        var msg = 'パスワードの変更に失敗しました。';
                        if (result.error.message.includes('same')) {
                            msg = '現在と同じパスワードは設定できません。';
                        } else if (result.error.message.includes('weak') || result.error.message.includes('short')) {
                            msg = 'パスワードが弱すぎます。より複雑なパスワードを設定してください。';
                        } else if (result.error.message.includes('session') || result.error.message.includes('token')) {
                            msg = 'リンクの有効期限が切れています。<a href="forgot-password.html">パスワード再設定をやり直す</a>';
                        }
                        showMessage(msg, 'error');
                    } else {
                        showMessage('パスワードを変更しました。ログインページに移動します...', 'success');
                        form.reset();
                        strengthFill.style.width = '0';
                        strengthText.textContent = '';

                        // ログアウトしてからログインページへ
                        await window.supabaseClient.auth.signOut();
                        setTimeout(function() {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                } catch (err) {
                    console.error('[ResetPassword] エラー:', err);
                    showMessage(err.message || 'エラーが発生しました。もう一度お試しください。', 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonText.style.display = 'inline';
                    loadingIcon.style.display = 'none';
                }
            });

            function showMessage(message, type) {
                statusMessage.style.display = 'block';
                messageText.innerHTML = message;
                statusMessage.className = 'auth-message';
                if (type === 'error') {
                    statusMessage.classList.add('error');
                    statusMessage.querySelector('i').className = 'fas fa-exclamation-circle';
                } else if (type === 'success') {
                    statusMessage.classList.add('success');
                    statusMessage.querySelector('i').className = 'fas fa-check-circle';
                } else {
                    statusMessage.querySelector('i').className = 'fas fa-spinner fa-spin';
                }
            }
        });
    })();
    </script>
    <style>
        .password-strength { margin-top: 8px; }
        .strength-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .strength-fill {
            height: 100%;
            width: 0;
            border-radius: 2px;
            transition: width 0.3s, background 0.3s;
        }
        .strength-text {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            transition: color 0.3s;
        }
    </style>
</body>
</html>
