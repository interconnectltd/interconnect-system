<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEèªè¨¼ä¸­ - INTERCONNECT</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha384-3B6NwesSXE7YJlcLI9RpRqGf2p/EgVH8BgoKTaUrmKNDkHPStTQ3EyoYjCGXaOTS" crossorigin="anonymous">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth-unified.css">
    
    <link rel="stylesheet" href="css/line-callback.css">
</head>
<body>
    <div class="callback-container">
        <div class="callback-card">
            <i class="fab fa-line callback-icon"></i>
            <h2 class="callback-title">LINEèªè¨¼å‡¦ç†ä¸­</h2>
            <p class="callback-message">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // SupabaseãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…ã¤
        window.addEventListener('supabaseReady', function() {
            console.log('ğŸ“ supabaseReady event fired in line-callback.html');
            handleLineCallback();
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šSupabaseãŒæ—¢ã«æº–å‚™æ¸ˆã¿ã®å ´åˆ
        if (window.supabase) {
            console.log('ğŸ“ Supabase already ready, calling handleLineCallback');
            handleLineCallback();
        }
        
        // ã•ã‚‰ãªã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šDOMContentLoadedã§å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“ DOMContentLoaded in line-callback.html');
            setTimeout(function() {
                if (window.supabase && !window._callbackHandled) {
                    console.log('ğŸ“ Fallback: calling handleLineCallback');
                    handleLineCallback();
                }
            }, 1000);
        });
        
        async function handleLineCallback() {
            // é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            if (window._callbackHandled) {
                console.log('âš ï¸ Callback already handled, skipping');
                return;
            }
            window._callbackHandled = true;
            
            console.log('ğŸš€ handleLineCallback started');
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('ğŸ“Œ Processing callback with:', {
                code: code ? code.substring(0, 10) + '...' : null,
                state: state ? state.substring(0, 10) + '...' : null,
                error: error
            });
            
            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (error) {
                showError(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${errorDescription || error}`);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            // stateãƒã‚§ãƒƒã‚¯ï¼ˆCSRFå¯¾ç­–ï¼‰
            const savedState = sessionStorage.getItem('line_state');
            if (!state || state !== savedState) {
                showError('ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            // codeãŒå­˜åœ¨ã—ãªã„å ´åˆ
            if (!code) {
                showError('èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            try {
                console.log('ğŸ“¡ Calling Netlify Function...');
                const apiUrl = '/.netlify/functions/line-auth-simple-v4';
                const requestBody = {
                    code: code,
                    redirect_uri: window.location.origin + '/line-callback.html'
                };
                
                console.log('API URL:', apiUrl);
                console.log('Request Body:', requestBody);
                
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦LINEèªè¨¼ã‚’å‡¦ç†ï¼ˆv2ã‚’ä½¿ç”¨ï¼‰
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('ğŸ“¡ Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Auth API Error:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«
                    let userMessage = 'èªè¨¼å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    if (error.error) {
                        if (error.error.includes('Database')) {
                            userMessage = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚';
                        } else if (error.error.includes('token')) {
                            userMessage = 'LINEèªè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                        } else if (error.error.includes('configuration')) {
                            userMessage = 'ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
                        }
                    }
                    
                    showError(userMessage);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 5000);
                    return;
                }
                
                const data = await response.json();
                console.log('ğŸ“¡ Auth response data:', data);

                // Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ï¼ˆverifyOtpï¼‰
                if (data.session && data.session.token_hash && window.supabaseClient) {
                    try {
                        const { data: authData, error: authError } = await window.supabaseClient.auth.verifyOtp({
                            token_hash: data.session.token_hash,
                            type: 'magiclink'
                        });
                        if (authError) {
                            console.error('Supabase session error:', authError);
                        } else {
                            console.log('âœ… Supabase session established');
                        }
                    } catch (sessionErr) {
                        console.error('Session verification error:', sessionErr);
                    }
                } else {
                    console.warn('âš ï¸ No session token or Supabase client not ready');
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆè£œåŠ©ç”¨ï¼‰
                const userData = {
                    id: data.user.id,
                    email: data.user.email,
                    name: data.user.display_name,
                    display_name: data.user.display_name,
                    picture: data.user.picture_url,
                    picture_url: data.user.picture_url,
                    provider: 'line',
                    line_user_id: data.user.line_user_id
                };

                console.log('Saving user data:', userData);
                localStorage.setItem('user', JSON.stringify(userData));
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                document.querySelector('.callback-message').textContent = 'èªè¨¼æˆåŠŸï¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™...';
                
                // æˆåŠŸã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´
                const icon = document.querySelector('.callback-icon');
                if (icon) {
                    icon.className = 'fas fa-check-circle callback-icon';
                    icon.style.color = '#10b981';
                }
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                console.log('Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = data.redirect_to || 'dashboard.html';
                }, 1000);
                
            } catch (err) {
                console.error('LINEèªè¨¼ã‚¨ãƒ©ãƒ¼:', err);
                showError('èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
    <script src="js/supabase-unified.js?v=1.1"></script>
</body>
</html>